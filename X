-- Zero System UI Library v4.0
-- Полностью переработанная версия на основе SaulGoodmanScripter Library

local ZeroLib = {}
ZeroLib.__index = ZeroLib
ZeroLib.Version = "4.0"

-- === КОНФИГУРАЦИЯ ===
local UIS = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

-- === ТЕМЫ (300 строк вместо 2000) ===
ZeroLib.Themes = {
    -- Базовые палитры (только основные цвета)
    Palettes = {
        Dark = {
            Shadow = {15, 15, 15},
            Background = {20, 20, 20},
            Page = {18, 18, 18},
            Main = {50, 50, 50},
            Text = {230, 230, 230},
            Accent = {0, 120, 215}
        },
        Amethyst = {
            Shadow = {24, 24, 31},
            Background = {29, 28, 38},
            Page = {24, 24, 31},
            Main = {91, 68, 209},
            Text = {255, 255, 255},
            Accent = {91, 68, 209}
        },
        Crimson = {
            Shadow = {40, 0, 0},
            Background = {60, 0, 10},
            Page = {50, 0, 5},
            Main = {180, 30, 60},
            Text = {255, 220, 220},
            Accent = {180, 30, 60}
        },
        -- ... остальные 11 тем (коротко)
    },
    
    -- Функции-генераторы (создают сложные цвета на лету)
    Generators = {
        -- Для Toggle
        Toggle = function(palette, state)
            local base = palette.Main
            if state == "True" then
                return {
                    Background = Color3.fromRGB(base[1]+40, base[2]+40, base[3]+40),
                    Value = Color3.fromRGB(base[1]+70, base[2]+70, base[3]+70)
                }
            else
                return {
                    Background = Color3.fromRGB(base[1]-20, base[2]-20, base[3]-20),
                    Value = Color3.fromRGB(base[1]-10, base[2]-10, base[3]-10)
                }
            end
        end,
        
        -- Для Slider
        Slider = function(palette)
            local main = palette.Main
            return {
                Bar = Color3.fromRGB(main[1]+20, main[2]+20, main[3]+20),
                BarValue = Color3.fromRGB(main[1]+40, main[2]+40, main[3]+40),
                Circle = Color3.fromRGB(255, 255, 255)
            }
        end,
        
        -- Для всех остальных элементов
        Default = function(palette, elementName)
            local base = palette.Main
            return {
                Background = Color3.fromRGB(base[1]-25, base[2]-25, base[3]-25),
                ValueBackground = Color3.fromRGB(base[1]-30, base[2]-30, base[3]-30),
                Stroke = Color3.fromRGB(palette.Text[1], palette.Text[2], palette.Text[3])
            }
        end
    }
}

-- === НОВАЯ СИСТЕМА ТЕМ (короткая и умная) ===
local ThemeStorage = {}
local CurrentTheme = "Dark"

-- Улучшенный addToTheme
function ZeroLib:addToTheme(path, object)
    if not ThemeStorage[path] then
        ThemeStorage[path] = {}
    end
    table.insert(ThemeStorage[path], object)
    
    -- Автоматически применяем текущую тему
    if self.CurrentPalette then
        self:applyThemeToObject(path, object)
    end
end

-- Умное применение темы
function ZeroLib:applyThemeToObject(path, object)
    local palette = self.Themes.Palettes[CurrentTheme]
    local generators = self.Themes.Generators
    
    -- Разбираем путь типа "Function.Toggle.Background"
    local parts = string.split(path, ".")
    
    if #parts == 3 and parts[1] == "Function" then
        -- Для элементов UI (Toggle, Slider и т.д.)
        local element = parts[2]
        local property = parts[3]
        
        if generators[element] then
            local colors = generators[element](palette, property == "True" and "True" or "False")
            local color = colors[property] or colors.Background
            self:setObjectColor(object, color)
        else
            local colors = generators.Default(palette, element)
            local color = colors[property] or colors.Background
            self:setObjectColor(object, color)
        end
    elseif #parts == 1 then
        -- Для базовых цветов (Shadow, Background и т.д.)
        local rgb = palette[parts[1]]
        if rgb then
            self:setObjectColor(object, Color3.fromRGB(rgb[1], rgb[2], rgb[3]))
        end
    end
end

-- Установка цвета для любого объекта
function ZeroLib:setObjectColor(obj, color)
    if obj:IsA("Frame") or obj:IsA("CanvasGroup") then
        obj.BackgroundColor3 = color
    elseif obj:IsA("TextLabel") or obj:IsA("TextButton") or obj:IsA("TextBox") then
        obj.TextColor3 = color
    elseif obj:IsA("ImageLabel") or obj:IsA("ImageButton") then
        obj.ImageColor3 = color
    elseif obj:IsA("UIStroke") then
        obj.Color = color
    elseif obj:IsA("UIGradient") then
        obj.Color = color
    elseif obj:IsA("ScrollingFrame") then
        obj.ScrollBarImageColor3 = color
    end
end

-- Полная смена темы
function ZeroLib:setTheme(themeName)
    if not self.Themes.Palettes[themeName] then
        warn("Тема '" .. themeName .. "' не найдена!")
        return
    end
    
    CurrentTheme = themeName
    self.CurrentPalette = self.Themes.Palettes[themeName]
    
    -- Обновляем ВСЕ сохранённые объекты
    for path, objects in pairs(ThemeStorage) do
        for _, obj in ipairs(objects) do
            self:applyThemeToObject(path, obj)
        end
    end
    
    -- Обновляем кнопку темы в UI
    if self.TopBar then
        local themeBtn = self.TopBar:FindFirstChild("ThemeButton")
        if themeBtn then
            themeBtn.Text = themeName
        end
    end
end

-- === ПЕРЕПИСАННЫЙ Func:Image() ===
function ZeroLib.Elements.Image(p)
    local config = p or {}
    
    local ImageLogo = Instance.new("ImageLabel")
    local UICorner = Instance.new("UICorner")
    
    ImageLogo.Name = "ZeroImage"
    ImageLogo.BackgroundTransparency = 1
    ImageLogo.Size = config.Size or UDim2.new(1, 0, 0, 180)
    ImageLogo.Image = config.Image or "rbxassetid://111362591084511"
    ImageLogo.ScaleType = config.ScaleType or Enum.ScaleType.Crop
    ImageLogo.ImageTransparency = config.Transparency or 0
    ImageLogo.Position = config.Position or UDim2.new(0.5, 0, 0.5, 0)
    ImageLogo.AnchorPoint = config.AnchorPoint or Vector2.new(0.5, 0.5)
    
    UICorner.Parent = ImageLogo
    UICorner.CornerRadius = UDim.new(0, config.CornerRadius or 8)
    
    -- Авто-размер если нужно
    if config.AutoSize then
        ImageLogo.Size = UDim2.new(1, 0, 0, 0)
        task.spawn(function()
            local contentSize = game:GetService("ContentProvider"):PreloadAsync({ImageLogo})
            ImageLogo.Size = UDim2.new(1, 0, 0, ImageLogo.AbsoluteSize.Y)
        end)
    end
    
    -- API
    local api = {}
    
    function api:SetImage(imageId)
        ImageLogo.Image = imageId
        return api
    end
    
    function api:SetSize(size)
        ImageLogo.Size = size
        return api
    end
    
    function api:SetTransparency(transparency)
        ImageLogo.ImageTransparency = transparency
        return api
    end
    
    function api:SetCornerRadius(radius)
        UICorner.CornerRadius = UDim.new(0, radius)
        return api
    end
    
    function api:SetPosition(position, anchorPoint)
        ImageLogo.Position = position
        if anchorPoint then
            ImageLogo.AnchorPoint = anchorPoint
        end
        return api
    end
    
    function api:Destroy()
        ImageLogo:Destroy()
    end
    
    function api:GetInstance()
        return ImageLogo
    end
    
    return {
        Instance = ImageLogo,
        API = api
    }
end

-- === СИСТЕМА ФОНОВЫХ КАРТИНОК ===
function ZeroLib:addBackgroundImage(parent, config)
    local bg = Instance.new("ImageLabel")
    bg.Name = "BackgroundImage"
    bg.Size = UDim2.new(1, 0, 1, 0)
    bg.Image = config.Image
    bg.ImageTransparency = config.Transparency or 0.8
    bg.ScaleType = config.ScaleType or Enum.ScaleType.Crop
    bg.BackgroundTransparency = 1
    bg.ZIndex = config.ZIndex or 0
    bg.Parent = parent
    
    -- Делаем основной фон полупрозрачным если нужно
    if config.MakeParentTransparent and parent:IsA("Frame") then
        parent.BackgroundTransparency = 0.5
    end
    
    local api = {}
    
    function api:Update(config)
        if config.Image then bg.Image = config.Image end
        if config.Transparency then bg.ImageTransparency = config.Transparency end
        if config.ScaleType then bg.ScaleType = config.ScaleType end
    end
    
    function api:Destroy()
        bg:Destroy()
        if parent:IsA("Frame") then
            parent.BackgroundTransparency = 0
        end
    end
    
    return api
end

-- === ОСНОВНОЕ ОКНО (адаптировано из оригинала) ===
function ZeroLib:Window(config)
    local window = {}
    
    -- Создаём ScreenGui
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "ZeroSystem"
    ScreenGui.Parent = RunService:IsStudio() and game.Players.LocalPlayer.PlayerGui or game.CoreGui
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    
    window.ScreenGui = ScreenGui
    
    -- Основное окно (упрощённая версия из оригинала)
    local Shadow = Instance.new("ImageLabel")
    Shadow.Name = "Shadow"
    Shadow.Parent = ScreenGui
    Shadow.AnchorPoint = Vector2.new(0.5, 0.5)
    Shadow.Position = UDim2.new(0.5, 0, 0.5, 0)
    Shadow.Size = config.Size or UDim2.new(0, 530, 0, 400)
    Shadow.Image = "rbxassetid://1316045217"
    Shadow.ImageTransparency = 0.8
    
    self:addToTheme("Shadow", Shadow)
    
    -- Фоновая картинка окна (если указана)
    if config.BackgroundImage then
        self:addBackgroundImage(Shadow, {
            Image = config.BackgroundImage,
            Transparency = config.BackgroundTransparency or 0.7,
            ScaleType = config.BackgroundScaleType,
            MakeParentTransparent = true
        })
    end
    
    -- ... остальной код создания окна из оригинала
    -- но с заменой всех вызовов addToTheme на self:addToTheme
    
    return window
end

-- === ИНИЦИАЛИЗАЦИЯ ===
function ZeroLib.new(config)
    local self = setmetatable({}, ZeroLib)
    
    -- Настройки
    self.Config = config or {}
    self.CurrentTheme = config.Theme or "Dark"
    
    -- Применяем тему по умолчанию
    self:setTheme(self.CurrentTheme)
    
    return self
end

return ZeroLib